# Техническое описание

Здесь представлено описание с технической стороны.


## Краткое описание

В протоколе участвуют 3 стороны:
* `Mail` - почтовый сервис
* `Principal` - сервис, выпускающий электронные токены
* `Identity` - сервис, который производит регистрацию

MailSig предполагает использование технологии JWT для подписи доменов. Подпись для домена добавляется через TXT запись с форматированным содержимым. `Principal` выпускает JWT для принятых заявок от `Mail` пользователей при помощи закрытого ключа. Открытый ключ распространяется между всеми `Identity` для валидации JWT.

Каждый JWT содержит в себе как минимум 2 обязательных поля:
* `domain` хранит имя домена, для которого выпущен JWT. Предотвращает переиспользование одного токена для нескольких доменов.
* `exp` хранит POSIX timestamp окончания срока службы JWT. После наступления `exp` токен больше не является валидным.

Под итерацией подразумевается период использования 1 пары ключей. Под токеном итерации подразумевается JWT, подписанный ключом определённой итерации.


## Формат TXT записи

Для TXT записи предлагается использовать формат `mailsig:<токен текущей итерации>[,<токен предыдущей итерации>]`, квадратными `[]` скобками отмечена необязательная часть. Токен предыдущей итерации нужен только в период миграции, чтобы сохранить совместимость до полного перехода всех `Identity` на новый ключ.

Регулярное выражение для формата: `mailsig:([^,]+)(?:,([^,]+))?`.


## Обновление открытых ключей Identity

`Principal` размещает текущий публичный ключ на одном неизменном URL в виде статического файла. Так же `Principal` определяет длительность стандартного цикла обновления: это время в течение которого должно произойти хотя бы 1 обновление ключа у всех `Identity`.

Ключи обновляются вручную или через периодический запуск скрипта на машине `Identity` (например через `cron`) в соответствии с длительностью цикла обновления. Скрипт перекачивает файл ключа с серверов `Principal`.


## Плановая ротация ключей

`Principal` определяет длительность стандартного периода миграции как число циклов обновления.

Для плановой замены RSA ключей `Principal` генерирует новую пару и заменяет старые файлы ключей на новые, включая приватный ключ для создания JWT. Открывается период миграции.

Все `Mail` создают повторные заявки и получают JWT новой итерации. Далее `Mail` заменяют значение TXT записи в домене: старый обязательный токен устанавливают на место необязательного, а новым заменяют текущий. Пример:
```
mailsig:token1,oldtoken -> mailsig:newtoken,token1
```

Все `Identity` обновляют локальные копии открытых ключей вручную или скриптом.


## Экстренная ротация ключей

Если нужно экстренно заменить ключи, например при компромитации, используется тот же алгоритм, что и для плановой смены, **НО** длительность периода миграции может быть сильно уменьшена. Длительность периода миграции <2 циклов обновления могжет вызвать проблемы с совместимостью.


## Валидация домена

Для валидации домена нужно получить его TXT запись с mailsig токенами. Это можно сделать при помощи регулярного выражения и NS Lookup. Если такой записи нет, домен считается невалидным. После получения токенов нужно совершить следующие проверки:

1. Проверить JWS-подпись токена текущей итерации.
2. Если валидация провалилась:
2.1. Если токен предыдущей итерации задан, проверить его JWS-подпись, иначе домен невалиден.
3. Проверить, что текущий POSIX timestamp меньше `exp`, иначе домен невалиден.
4. Проверить, что `domain` идентичен проверяемому домену, иначе домен невалиден.
5. Продолжить регистрацию (домен валиден) -> ...


## Замена токена по истечению срока службы

По истечении срока службы токена `Mail` заполняет новую заявку и проходит стандартный процесс получения токена для домена.
